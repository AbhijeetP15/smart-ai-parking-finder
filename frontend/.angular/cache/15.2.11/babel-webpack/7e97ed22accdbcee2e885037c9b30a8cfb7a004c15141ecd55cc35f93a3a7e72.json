{"ast":null,"code":"import { HttpParams } from '@angular/common/http';\nimport { BehaviorSubject, Subject } from 'rxjs';\nimport { map, catchError, tap } from 'rxjs/operators';\nimport { io } from 'socket.io-client';\nimport { environment } from '../../../environments/environment';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nexport class ParkingService {\n  constructor(http) {\n    this.http = http;\n    this.apiUrl = environment.apiUrl;\n    // Radius and location for real data\n    this.currentRadius = 5000; // Default 5km\n    this.currentLat = 33.4242; // Default ASU coordinates\n    this.currentLng = -111.9281;\n    this.useRealData = true; // Use real OSM data\n    this.parkingLotsSubject = new BehaviorSubject([]);\n    this.parkingLots$ = this.parkingLotsSubject.asObservable();\n    this.parkingUpdateSubject = new Subject();\n    this.parkingUpdates$ = this.parkingUpdateSubject.asObservable();\n    this.connectionStatusSubject = new BehaviorSubject(false);\n    this.connectionStatus$ = this.connectionStatusSubject.asObservable();\n    this.initializeWebSocket();\n  }\n  initializeWebSocket() {\n    this.socket = io(environment.wsUrl, {\n      reconnection: true,\n      reconnectionDelay: 1000,\n      reconnectionAttempts: 5\n    });\n    this.socket.on('connect', () => {\n      console.log('WebSocket connected');\n      this.connectionStatusSubject.next(true);\n    });\n    this.socket.on('disconnect', () => {\n      console.log('WebSocket disconnected');\n      this.connectionStatusSubject.next(false);\n    });\n    this.socket.on('parking-update', update => {\n      this.parkingUpdateSubject.next(update);\n      this.updateLocalParkingLot(update);\n    });\n    this.socket.on('connect_error', error => {\n      console.error('WebSocket connection error:', error);\n    });\n  }\n  updateLocalParkingLot(update) {\n    const currentLots = this.parkingLotsSubject.value;\n    const updatedLots = currentLots.map(lot => lot.id === update.lotId ? {\n      ...lot,\n      availableSpots: update.availableSpots,\n      lastUpdate: update.timestamp\n    } : lot);\n    this.parkingLotsSubject.next(updatedLots);\n  }\n  getAllParkingLots() {\n    const endpoint = this.useRealData ? `${this.apiUrl}/parking-lots/real?lat=${this.currentLat}&lng=${this.currentLng}&radius=${this.currentRadius}` : `${this.apiUrl}/parking-lots`;\n    return this.http.get(endpoint).pipe(tap(lots => this.parkingLotsSubject.next(lots)), catchError(error => {\n      console.error('Error fetching parking lots:', error);\n      throw error;\n    }));\n  }\n  setRadius(radius) {\n    this.currentRadius = radius;\n  }\n  setLocation(lat, lng) {\n    this.currentLat = lat;\n    this.currentLng = lng;\n  }\n  getCurrentRadius() {\n    return this.currentRadius;\n  }\n  getParkingLotById(id) {\n    return this.http.get(`${this.apiUrl}/parking-lots/${id}`).pipe(catchError(error => {\n      console.error(`Error fetching parking lot ${id}:`, error);\n      throw error;\n    }));\n  }\n  updateParkingLot(id, availableSpots, sensors) {\n    const body = {\n      availableSpots,\n      sensors\n    };\n    return this.http.put(`${this.apiUrl}/parking-lots/${id}`, body).pipe(catchError(error => {\n      console.error(`Error updating parking lot ${id}:`, error);\n      throw error;\n    }));\n  }\n  getPrediction(id, minutesAhead = 30) {\n    const params = new HttpParams().set('minutes', minutesAhead.toString());\n    return this.http.get(`${this.apiUrl}/parking-lots/${id}/predict`, {\n      params\n    }).pipe(catchError(error => {\n      console.error(`Error fetching prediction for lot ${id}:`, error);\n      throw error;\n    }));\n  }\n  getHistoricalData(id, limit = 100) {\n    const params = new HttpParams().set('limit', limit.toString());\n    return this.http.get(`${this.apiUrl}/parking-lots/${id}/history`, {\n      params\n    }).pipe(catchError(error => {\n      console.error(`Error fetching historical data for lot ${id}:`, error);\n      throw error;\n    }));\n  }\n  getStats() {\n    return this.http.get(`${this.apiUrl}/stats`).pipe(catchError(error => {\n      console.error('Error fetching stats:', error);\n      throw error;\n    }));\n  }\n  createParkingLot(lot) {\n    return this.http.post(`${this.apiUrl}/parking-lots`, lot).pipe(tap(newLot => {\n      const currentLots = this.parkingLotsSubject.value;\n      this.parkingLotsSubject.next([...currentLots, newLot]);\n    }), catchError(error => {\n      console.error('Error creating parking lot:', error);\n      throw error;\n    }));\n  }\n  subscribeToParkingLot(lotId) {\n    if (this.socket.connected) {\n      this.socket.emit('subscribe', lotId);\n      console.log(`Subscribed to parking lot: ${lotId}`);\n    } else {\n      console.warn('Socket not connected. Will subscribe when connection is established.');\n      this.socket.once('connect', () => {\n        this.socket.emit('subscribe', lotId);\n      });\n    }\n  }\n  unsubscribeFromParkingLot(lotId) {\n    if (this.socket.connected) {\n      this.socket.emit('unsubscribe', lotId);\n      console.log(`Unsubscribed from parking lot: ${lotId}`);\n    }\n  }\n  getOccupancyRate(lot) {\n    return (lot.totalSpots - lot.availableSpots) / lot.totalSpots * 100;\n  }\n  getStatusLabel(lot) {\n    const occupancy = this.getOccupancyRate(lot);\n    if (occupancy < 50) return 'Available';\n    if (occupancy < 80) return 'Moderate';\n    return 'Full';\n  }\n  getStatusColor(lot) {\n    const occupancy = this.getOccupancyRate(lot);\n    if (occupancy < 50) return 'green';\n    if (occupancy < 80) return 'yellow';\n    return 'red';\n  }\n  calculateDistance(lat1, lng1, lat2, lng2) {\n    const R = 6371;\n    const dLat = this.toRad(lat2 - lat1);\n    const dLng = this.toRad(lng2 - lng1);\n    const a = Math.sin(dLat / 2) ** 2 + Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * Math.sin(dLng / 2) ** 2;\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n    return R * c;\n  }\n  toRad(degrees) {\n    return degrees * (Math.PI / 180);\n  }\n  getNearestParkingLot(userLat, userLng) {\n    return this.parkingLots$.pipe(map(lots => {\n      if (lots.length === 0) return null;\n      let nearest = lots[0];\n      let minDistance = this.calculateDistance(userLat, userLng, nearest.location.lat, nearest.location.lng);\n      lots.forEach(lot => {\n        const distance = this.calculateDistance(userLat, userLng, lot.location.lat, lot.location.lng);\n        if (distance < minDistance) {\n          minDistance = distance;\n          nearest = lot;\n        }\n      });\n      return nearest;\n    }));\n  }\n  filterByAvailability(lots, minSpots) {\n    return lots.filter(lot => lot.availableSpots >= minSpots);\n  }\n  sortByAvailability(lots) {\n    return [...lots].sort((a, b) => b.availableSpots - a.availableSpots);\n  }\n  disconnect() {\n    if (this.socket) {\n      this.socket.disconnect();\n      console.log('WebSocket disconnected manually');\n    }\n  }\n  reconnect() {\n    if (this.socket) {\n      this.socket.connect();\n      console.log('WebSocket reconnecting...');\n    }\n  }\n  static {\n    this.ɵfac = function ParkingService_Factory(t) {\n      return new (t || ParkingService)(i0.ɵɵinject(i1.HttpClient));\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: ParkingService,\n      factory: ParkingService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}","map":{"version":3,"mappings":"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","names":["HttpParams","BehaviorSubject","Subject","map","catchError","tap","io","environment","ParkingService","constructor","http","apiUrl","parkingLotsSubject","asObservable","parkingUpdateSubject","connectionStatusSubject","initializeWebSocket","socket","wsUrl","reconnection","reconnectionDelay","reconnectionAttempts","on","console","log","next","update","updateLocalParkingLot","error","currentLots","value","updatedLots","lot","id","lotId","availableSpots","lastUpdate","timestamp","getAllParkingLots","endpoint","useRealData","currentLat","currentLng","currentRadius","get","pipe","lots","setRadius","radius","setLocation","lat","lng","getCurrentRadius","getParkingLotById","updateParkingLot","sensors","body","put","getPrediction","minutesAhead","params","set","toString","getHistoricalData","limit","getStats","createParkingLot","post","newLot","subscribeToParkingLot","connected","emit","warn","once","unsubscribeFromParkingLot","getOccupancyRate","totalSpots","getStatusLabel","occupancy","getStatusColor","calculateDistance","lat1","lng1","lat2","lng2","R","dLat","toRad","dLng","a","Math","sin","cos","c","atan2","sqrt","degrees","PI","getNearestParkingLot","userLat","userLng","parkingLots$","length","nearest","minDistance","location","forEach","distance","filterByAvailability","minSpots","filter","sortByAvailability","sort","b","disconnect","reconnect","connect","factory","providedIn"],"sourceRoot":"","sources":["C:\\Users\\abhij\\Documents\\Smart-AI Parking Finder\\frontend\\src\\app\\services\\parking.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { HttpClient, HttpParams } from '@angular/common/http';\nimport { Observable, BehaviorSubject, Subject } from 'rxjs';\nimport { map, catchError, tap } from 'rxjs/operators';\nimport { io, Socket } from 'socket.io-client';\nimport { environment } from '../../../environments/environment';\n\r\nexport interface Location {\r\n  lat: number;\r\n  lng: number;\r\n}\r\n\r\nexport interface Sensor {\r\n  spotId: string;\r\n  isOccupied: boolean;\r\n  lastUpdate: Date;\r\n}\r\n\r\nexport interface ParkingLot {\r\n  id: string;\r\n  name: string;\r\n  totalSpots: number;\r\n  availableSpots: number;\r\n  location: Location;\r\n  lastUpdate: string;\r\n  predictedAvailability: number;\r\n  confidence: number;\r\n  sensors?: Sensor[];\r\n}\r\n\r\nexport interface PredictionResponse {\r\n  predictedSpots: number;\r\n  confidence: number;\r\n  predictedFor: string;\r\n}\r\n\r\nexport interface HistoricalData {\r\n  parkingLotId: string;\r\n  timestamp: string;\r\n  availableSpots: number;\r\n  occupancyRate: number;\r\n  dayOfWeek: number;\r\n  hour: number;\r\n}\r\n\r\nexport interface Stats {\r\n  totalParkingLots: number;\r\n  totalSpots: number;\r\n  totalAvailable: number;\r\n  avgOccupancy: number;\r\n}\r\n\r\nexport interface ParkingUpdate {\r\n  lotId: string;\r\n  availableSpots: number;\r\n  timestamp: string;\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ParkingService {\r\n  private apiUrl = environment.apiUrl;\n  private socket!: Socket;\n\r\n  // Radius and location for real data\r\n  private currentRadius = 5000; // Default 5km\r\n  private currentLat = 33.4242; // Default ASU coordinates\r\n  private currentLng = -111.9281;\r\n  private useRealData = true; // Use real OSM data\r\n\r\n  private parkingLotsSubject = new BehaviorSubject<ParkingLot[]>([]);\r\n  public parkingLots$ = this.parkingLotsSubject.asObservable();\r\n\r\n  private parkingUpdateSubject = new Subject<ParkingUpdate>();\r\n  public parkingUpdates$ = this.parkingUpdateSubject.asObservable();\r\n\r\n  private connectionStatusSubject = new BehaviorSubject<boolean>(false);\r\n  public connectionStatus$ = this.connectionStatusSubject.asObservable();\r\n\r\n  constructor(private http: HttpClient) {\r\n    this.initializeWebSocket();\r\n  }\r\n\r\n  private initializeWebSocket(): void {\r\n    this.socket = io(environment.wsUrl, {\n      reconnection: true,\n      reconnectionDelay: 1000,\n      reconnectionAttempts: 5\n    });\n\r\n    this.socket.on('connect', () => {\r\n      console.log('WebSocket connected');\r\n      this.connectionStatusSubject.next(true);\r\n    });\r\n\r\n    this.socket.on('disconnect', () => {\r\n      console.log('WebSocket disconnected');\r\n      this.connectionStatusSubject.next(false);\r\n    });\r\n\r\n    this.socket.on('parking-update', (update: ParkingUpdate) => {\r\n      this.parkingUpdateSubject.next(update);\r\n      this.updateLocalParkingLot(update);\r\n    });\r\n\r\n    this.socket.on('connect_error', (error) => {\r\n      console.error('WebSocket connection error:', error);\r\n    });\r\n  }\r\n\r\n  private updateLocalParkingLot(update: ParkingUpdate): void {\r\n    const currentLots = this.parkingLotsSubject.value;\r\n    const updatedLots = currentLots.map(lot =>\r\n      lot.id === update.lotId\r\n        ? { ...lot, availableSpots: update.availableSpots, lastUpdate: update.timestamp }\r\n        : lot\r\n    );\r\n    this.parkingLotsSubject.next(updatedLots);\r\n  }\r\n\r\n  getAllParkingLots(): Observable<ParkingLot[]> {\r\n    const endpoint = this.useRealData \r\n      ? `${this.apiUrl}/parking-lots/real?lat=${this.currentLat}&lng=${this.currentLng}&radius=${this.currentRadius}`\r\n      : `${this.apiUrl}/parking-lots`;\r\n    \r\n    return this.http.get<ParkingLot[]>(endpoint).pipe(\r\n      tap(lots => this.parkingLotsSubject.next(lots)),\r\n      catchError(error => {\r\n        console.error('Error fetching parking lots:', error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  setRadius(radius: number): void {\r\n    this.currentRadius = radius;\r\n  }\r\n\r\n  setLocation(lat: number, lng: number): void {\r\n    this.currentLat = lat;\r\n    this.currentLng = lng;\r\n  }\r\n\r\n  getCurrentRadius(): number {\r\n    return this.currentRadius;\r\n  }\r\n\r\n  getParkingLotById(id: string): Observable<ParkingLot> {\r\n    return this.http.get<ParkingLot>(`${this.apiUrl}/parking-lots/${id}`).pipe(\r\n      catchError(error => {\r\n        console.error(`Error fetching parking lot ${id}:`, error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  updateParkingLot(id: string, availableSpots: number, sensors?: Sensor[]): Observable<ParkingLot> {\r\n    const body = { availableSpots, sensors };\r\n    return this.http.put<ParkingLot>(`${this.apiUrl}/parking-lots/${id}`, body).pipe(\r\n      catchError(error => {\r\n        console.error(`Error updating parking lot ${id}:`, error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  getPrediction(id: string, minutesAhead: number = 30): Observable<PredictionResponse> {\r\n    const params = new HttpParams().set('minutes', minutesAhead.toString());\r\n    return this.http.get<PredictionResponse>(\r\n      `${this.apiUrl}/parking-lots/${id}/predict`,\r\n      { params }\r\n    ).pipe(\r\n      catchError(error => {\r\n        console.error(`Error fetching prediction for lot ${id}:`, error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  getHistoricalData(id: string, limit: number = 100): Observable<HistoricalData[]> {\r\n    const params = new HttpParams().set('limit', limit.toString());\r\n    return this.http.get<HistoricalData[]>(\r\n      `${this.apiUrl}/parking-lots/${id}/history`,\r\n      { params }\r\n    ).pipe(\r\n      catchError(error => {\r\n        console.error(`Error fetching historical data for lot ${id}:`, error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  getStats(): Observable<Stats> {\r\n    return this.http.get<Stats>(`${this.apiUrl}/stats`).pipe(\r\n      catchError(error => {\r\n        console.error('Error fetching stats:', error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  createParkingLot(lot: Partial<ParkingLot>): Observable<ParkingLot> {\r\n    return this.http.post<ParkingLot>(`${this.apiUrl}/parking-lots`, lot).pipe(\r\n      tap(newLot => {\r\n        const currentLots = this.parkingLotsSubject.value;\r\n        this.parkingLotsSubject.next([...currentLots, newLot]);\r\n      }),\r\n      catchError(error => {\r\n        console.error('Error creating parking lot:', error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  subscribeToParkingLot(lotId: string): void {\r\n    if (this.socket.connected) {\r\n      this.socket.emit('subscribe', lotId);\r\n      console.log(`Subscribed to parking lot: ${lotId}`);\r\n    } else {\r\n      console.warn('Socket not connected. Will subscribe when connection is established.');\r\n      this.socket.once('connect', () => {\r\n        this.socket.emit('subscribe', lotId);\r\n      });\r\n    }\r\n  }\r\n\r\n  unsubscribeFromParkingLot(lotId: string): void {\r\n    if (this.socket.connected) {\r\n      this.socket.emit('unsubscribe', lotId);\r\n      console.log(`Unsubscribed from parking lot: ${lotId}`);\r\n    }\r\n  }\r\n\r\n  getOccupancyRate(lot: ParkingLot): number {\r\n    return ((lot.totalSpots - lot.availableSpots) / lot.totalSpots) * 100;\r\n  }\r\n\r\n  getStatusLabel(lot: ParkingLot): string {\r\n    const occupancy = this.getOccupancyRate(lot);\r\n    if (occupancy < 50) return 'Available';\r\n    if (occupancy < 80) return 'Moderate';\r\n    return 'Full';\r\n  }\r\n\r\n  getStatusColor(lot: ParkingLot): string {\r\n    const occupancy = this.getOccupancyRate(lot);\r\n    if (occupancy < 50) return 'green';\r\n    if (occupancy < 80) return 'yellow';\r\n    return 'red';\r\n  }\r\n\r\n  calculateDistance(lat1: number, lng1: number, lat2: number, lng2: number): number {\r\n    const R = 6371;\r\n    const dLat = this.toRad(lat2 - lat1);\r\n    const dLng = this.toRad(lng2 - lng1);\r\n    const a =\r\n      Math.sin(dLat / 2) ** 2 +\r\n      Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) *\r\n      Math.sin(dLng / 2) ** 2;\r\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\r\n    return R * c;\r\n  }\r\n\r\n  private toRad(degrees: number): number {\r\n    return degrees * (Math.PI / 180);\r\n  }\r\n\r\n  getNearestParkingLot(userLat: number, userLng: number): Observable<ParkingLot | null> {\r\n    return this.parkingLots$.pipe(\r\n      map(lots => {\r\n        if (lots.length === 0) return null;\r\n        \r\n        let nearest = lots[0];\r\n        let minDistance = this.calculateDistance(\r\n          userLat, userLng, \r\n          nearest.location.lat, nearest.location.lng\r\n        );\r\n\r\n        lots.forEach(lot => {\r\n          const distance = this.calculateDistance(\r\n            userLat, userLng,\r\n            lot.location.lat, lot.location.lng\r\n          );\r\n          if (distance < minDistance) {\r\n            minDistance = distance;\r\n            nearest = lot;\r\n          }\r\n        });\r\n\r\n        return nearest;\r\n      })\r\n    );\r\n  }\r\n\r\n  filterByAvailability(lots: ParkingLot[], minSpots: number): ParkingLot[] {\r\n    return lots.filter(lot => lot.availableSpots >= minSpots);\r\n  }\r\n\r\n  sortByAvailability(lots: ParkingLot[]): ParkingLot[] {\r\n    return [...lots].sort((a, b) => b.availableSpots - a.availableSpots);\r\n  }\r\n\r\n  disconnect(): void {\r\n    if (this.socket) {\r\n      this.socket.disconnect();\r\n      console.log('WebSocket disconnected manually');\r\n    }\r\n  }\r\n\r\n  reconnect(): void {\r\n    if (this.socket) {\r\n      this.socket.connect();\r\n      console.log('WebSocket reconnecting...');\r\n    }\r\n  }\r\n}\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}