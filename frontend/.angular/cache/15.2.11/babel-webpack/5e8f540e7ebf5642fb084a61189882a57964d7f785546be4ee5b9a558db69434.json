{"ast":null,"code":"import { HttpParams } from '@angular/common/http';\nimport { BehaviorSubject, Subject } from 'rxjs';\nimport { catchError, tap } from 'rxjs/operators';\nimport { io } from 'socket.io-client';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nexport class ParkingService {\n  constructor(http) {\n    this.http = http;\n    this.apiUrl = 'http://localhost:3000/api';\n    this.parkingLotsSubject = new BehaviorSubject([]);\n    this.parkingLots$ = this.parkingLotsSubject.asObservable();\n    this.parkingUpdateSubject = new Subject();\n    this.parkingUpdates$ = this.parkingUpdateSubject.asObservable();\n    this.connectionStatusSubject = new BehaviorSubject(false);\n    this.connectionStatus$ = this.connectionStatusSubject.asObservable();\n    this.initializeWebSocket();\n  }\n  initializeWebSocket() {\n    this.socket = io('http://localhost:3000', {\n      reconnection: true,\n      reconnectionDelay: 1000,\n      reconnectionAttempts: 5\n    });\n    this.socket.on('connect', () => {\n      console.log('WebSocket connected');\n      this.connectionStatusSubject.next(true);\n    });\n    this.socket.on('disconnect', () => {\n      console.log('WebSocket disconnected');\n      this.connectionStatusSubject.next(false);\n    });\n    this.socket.on('parking-update', update => {\n      this.parkingUpdateSubject.next(update);\n      this.updateLocalParkingLot(update);\n    });\n    this.socket.on('connect_error', error => {\n      console.error('WebSocket connection error:', error);\n    });\n  }\n  updateLocalParkingLot(update) {\n    const currentLots = this.parkingLotsSubject.value;\n    const updatedLots = currentLots.map(lot => lot.id === update.lotId ? {\n      ...lot,\n      availableSpots: update.availableSpots,\n      lastUpdate: update.timestamp\n    } : lot);\n    this.parkingLotsSubject.next(updatedLots);\n  }\n  /** REVERTED: simple DB list (no lat/lng/radius, no /real) */\n  getAllParkingLots() {\n    return this.http.get(`${this.apiUrl}/parking-lots`).pipe(tap(lots => this.parkingLotsSubject.next(lots)), catchError(error => {\n      console.error('Error fetching parking lots:', error);\n      throw error;\n    }));\n  }\n  getParkingLotById(id) {\n    return this.http.get(`${this.apiUrl}/parking-lots/${id}`).pipe(catchError(error => {\n      console.error(`Error fetching parking lot ${id}:`, error);\n      throw error;\n    }));\n  }\n  updateParkingLot(id, availableSpots, sensors) {\n    const body = {\n      availableSpots,\n      sensors\n    };\n    return this.http.put(`${this.apiUrl}/parking-lots/${id}`, body).pipe(catchError(error => {\n      console.error(`Error updating parking lot ${id}:`, error);\n      throw error;\n    }));\n  }\n  getPrediction(id, minutesAhead = 30) {\n    const params = new HttpParams().set('minutes', minutesAhead.toString());\n    return this.http.get(`${this.apiUrl}/parking-lots/${id}/predict`, {\n      params\n    }).pipe(catchError(error => {\n      console.error(`Error fetching prediction for lot ${id}:`, error);\n      throw error;\n    }));\n  }\n  getHistoricalData(id, limit = 100) {\n    const params = new HttpParams().set('limit', limit.toString());\n    return this.http.get(`${this.apiUrl}/parking-lots/${id}/history`, {\n      params\n    }).pipe(catchError(error => {\n      console.error(`Error fetching historical data for lot ${id}:`, error);\n      throw error;\n    }));\n  }\n  getStats() {\n    return this.http.get(`${this.apiUrl}/stats`).pipe(catchError(error => {\n      console.error('Error fetching stats:', error);\n      throw error;\n    }));\n  }\n  createParkingLot(lot) {\n    return this.http.post(`${this.apiUrl}/parking-lots`, lot).pipe(tap(newLot => {\n      const currentLots = this.parkingLotsSubject.value;\n      this.parkingLotsSubject.next([...currentLots, newLot]);\n    }), catchError(error => {\n      console.error('Error creating parking lot:', error);\n      throw error;\n    }));\n  }\n  subscribeToParkingLot(lotId) {\n    if (this.socket.connected) {\n      this.socket.emit('subscribe', lotId);\n      console.log(`Subscribed to parking lot: ${lotId}`);\n    } else {\n      console.warn('Socket not connected. Will subscribe when connection is established.');\n      this.socket.once('connect', () => {\n        this.socket.emit('subscribe', lotId);\n      });\n    }\n  }\n  unsubscribeFromParkingLot(lotId) {\n    if (this.socket.connected) {\n      this.socket.emit('unsubscribe', lotId);\n      console.log(`Unsubscribed from parking lot: ${lotId}`);\n    }\n  }\n  getOccupancyRate(lot) {\n    return (lot.totalSpots - lot.availableSpots) / lot.totalSpots * 100;\n  }\n  getStatusLabel(lot) {\n    const occupancy = this.getOccupancyRate(lot);\n    if (occupancy < 50) return 'Available';\n    if (occupancy < 80) return 'Moderate';\n    return 'Full';\n  }\n  getStatusColor(lot) {\n    const occupancy = this.getOccupancyRate(lot);\n    if (occupancy < 50) return 'green';\n    if (occupancy < 80) return 'yellow';\n    return 'red';\n  }\n  calculateDistance(lat1, lng1, lat2, lng2) {\n    const R = 6371;\n    const dLat = this.toRad(lat2 - lat1);\n    const dLng = this.toRad(lng2 - lng1);\n    const a = Math.sin(dLat / 2) ** 2 + Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) * Math.sin(dLng / 2) ** 2;\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n    return R * c;\n  }\n  toRad(degrees) {\n    return degrees * (Math.PI / 180);\n  }\n  disconnect() {\n    if (this.socket) {\n      this.socket.disconnect();\n      console.log('WebSocket disconnected manually');\n    }\n  }\n  reconnect() {\n    if (this.socket) {\n      this.socket.connect();\n      console.log('WebSocket reconnecting...');\n    }\n  }\n  static {\n    this.ɵfac = function ParkingService_Factory(t) {\n      return new (t || ParkingService)(i0.ɵɵinject(i1.HttpClient));\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: ParkingService,\n      factory: ParkingService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}","map":{"version":3,"mappings":"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","names":["HttpParams","BehaviorSubject","Subject","catchError","tap","io","ParkingService","constructor","http","parkingLotsSubject","asObservable","parkingUpdateSubject","connectionStatusSubject","initializeWebSocket","socket","reconnection","reconnectionDelay","reconnectionAttempts","on","console","log","next","update","updateLocalParkingLot","error","currentLots","value","updatedLots","map","lot","id","lotId","availableSpots","lastUpdate","timestamp","getAllParkingLots","get","apiUrl","pipe","lots","getParkingLotById","updateParkingLot","sensors","body","put","getPrediction","minutesAhead","params","set","toString","getHistoricalData","limit","getStats","createParkingLot","post","newLot","subscribeToParkingLot","connected","emit","warn","once","unsubscribeFromParkingLot","getOccupancyRate","totalSpots","getStatusLabel","occupancy","getStatusColor","calculateDistance","lat1","lng1","lat2","lng2","R","dLat","toRad","dLng","a","Math","sin","cos","c","atan2","sqrt","degrees","PI","disconnect","reconnect","connect","factory","providedIn"],"sourceRoot":"","sources":["C:\\Users\\abhij\\Documents\\Smart-AI Parking Finder\\frontend\\src\\app\\services\\parking.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\nimport { Observable, BehaviorSubject, Subject } from 'rxjs';\r\nimport { map, catchError, tap } from 'rxjs/operators';\r\nimport { io, Socket } from 'socket.io-client';\r\n\r\nexport interface Location {\r\n  lat: number;\r\n  lng: number;\r\n}\r\n\r\nexport interface Sensor {\r\n  spotId: string;\r\n  isOccupied: boolean;\r\n  lastUpdate: Date;\r\n}\r\n\r\nexport interface ParkingLot {\r\n  id: string;\r\n  name: string;\r\n  totalSpots: number;\r\n  availableSpots: number;\r\n  location: Location;\r\n  lastUpdate: string;\r\n  predictedAvailability: number;\r\n  confidence: number;\r\n  sensors?: Sensor[];\r\n}\r\n\r\nexport interface PredictionResponse {\r\n  predictedSpots: number;\r\n  confidence: number;\r\n  predictedFor: string;\r\n}\r\n\r\nexport interface HistoricalData {\r\n  parkingLotId: string;\r\n  timestamp: string;\r\n  availableSpots: number;\r\n  occupancyRate: number;\r\n  dayOfWeek: number;\r\n  hour: number;\r\n}\r\n\r\nexport interface Stats {\r\n  totalParkingLots: number;\r\n  totalSpots: number;\r\n  totalAvailable: number;\r\n  avgOccupancy: number;\r\n}\r\n\r\nexport interface ParkingUpdate {\r\n  lotId: string;\r\n  availableSpots: number;\r\n  timestamp: string;\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ParkingService {\r\n  private apiUrl = 'http://localhost:3000/api';\r\n  private socket!: Socket;\r\n\r\n  private parkingLotsSubject = new BehaviorSubject<ParkingLot[]>([]);\r\n  public parkingLots$ = this.parkingLotsSubject.asObservable();\r\n\r\n  private parkingUpdateSubject = new Subject<ParkingUpdate>();\r\n  public parkingUpdates$ = this.parkingUpdateSubject.asObservable();\r\n\r\n  private connectionStatusSubject = new BehaviorSubject<boolean>(false);\r\n  public connectionStatus$ = this.connectionStatusSubject.asObservable();\r\n\r\n  constructor(private http: HttpClient) {\r\n    this.initializeWebSocket();\r\n  }\r\n\r\n  private initializeWebSocket(): void {\r\n    this.socket = io('http://localhost:3000', {\r\n      reconnection: true,\r\n      reconnectionDelay: 1000,\r\n      reconnectionAttempts: 5\r\n    });\r\n\r\n    this.socket.on('connect', () => {\r\n      console.log('WebSocket connected');\r\n      this.connectionStatusSubject.next(true);\r\n    });\r\n\r\n    this.socket.on('disconnect', () => {\r\n      console.log('WebSocket disconnected');\r\n      this.connectionStatusSubject.next(false);\r\n    });\r\n\r\n    this.socket.on('parking-update', (update: ParkingUpdate) => {\r\n      this.parkingUpdateSubject.next(update);\r\n      this.updateLocalParkingLot(update);\r\n    });\r\n\r\n    this.socket.on('connect_error', (error) => {\r\n      console.error('WebSocket connection error:', error);\r\n    });\r\n  }\r\n\r\n  private updateLocalParkingLot(update: ParkingUpdate): void {\r\n    const currentLots = this.parkingLotsSubject.value;\r\n    const updatedLots = currentLots.map(lot =>\r\n      lot.id === update.lotId\r\n        ? { ...lot, availableSpots: update.availableSpots, lastUpdate: update.timestamp }\r\n        : lot\r\n    );\r\n    this.parkingLotsSubject.next(updatedLots);\r\n  }\r\n\r\n  /** REVERTED: simple DB list (no lat/lng/radius, no /real) */\r\n  getAllParkingLots(): Observable<ParkingLot[]> {\r\n    return this.http.get<ParkingLot[]>(`${this.apiUrl}/parking-lots`).pipe(\r\n      tap(lots => this.parkingLotsSubject.next(lots)),\r\n      catchError(error => {\r\n        console.error('Error fetching parking lots:', error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  getParkingLotById(id: string): Observable<ParkingLot> {\r\n    return this.http.get<ParkingLot>(`${this.apiUrl}/parking-lots/${id}`).pipe(\r\n      catchError(error => {\r\n        console.error(`Error fetching parking lot ${id}:`, error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  updateParkingLot(id: string, availableSpots: number, sensors?: Sensor[]): Observable<ParkingLot> {\r\n    const body = { availableSpots, sensors };\r\n    return this.http.put<ParkingLot>(`${this.apiUrl}/parking-lots/${id}`, body).pipe(\r\n      catchError(error => {\r\n        console.error(`Error updating parking lot ${id}:`, error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  getPrediction(id: string, minutesAhead: number = 30): Observable<PredictionResponse> {\r\n    const params = new HttpParams().set('minutes', minutesAhead.toString());\r\n    return this.http.get<PredictionResponse>(\r\n      `${this.apiUrl}/parking-lots/${id}/predict`,\r\n      { params }\r\n    ).pipe(\r\n      catchError(error => {\r\n        console.error(`Error fetching prediction for lot ${id}:`, error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  getHistoricalData(id: string, limit: number = 100): Observable<HistoricalData[]> {\r\n    const params = new HttpParams().set('limit', limit.toString());\r\n    return this.http.get<HistoricalData[]>(\r\n      `${this.apiUrl}/parking-lots/${id}/history`,\r\n      { params }\r\n    ).pipe(\r\n      catchError(error => {\r\n        console.error(`Error fetching historical data for lot ${id}:`, error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  getStats(): Observable<Stats> {\r\n    return this.http.get<Stats>(`${this.apiUrl}/stats`).pipe(\r\n      catchError(error => {\r\n        console.error('Error fetching stats:', error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  createParkingLot(lot: Partial<ParkingLot>): Observable<ParkingLot> {\r\n    return this.http.post<ParkingLot>(`${this.apiUrl}/parking-lots`, lot).pipe(\r\n      tap(newLot => {\r\n        const currentLots = this.parkingLotsSubject.value;\r\n        this.parkingLotsSubject.next([...currentLots, newLot]);\r\n      }),\r\n      catchError(error => {\r\n        console.error('Error creating parking lot:', error);\r\n        throw error;\r\n      })\r\n    );\r\n  }\r\n\r\n  subscribeToParkingLot(lotId: string): void {\r\n    if (this.socket.connected) {\r\n      this.socket.emit('subscribe', lotId);\r\n      console.log(`Subscribed to parking lot: ${lotId}`);\r\n    } else {\r\n      console.warn('Socket not connected. Will subscribe when connection is established.');\r\n      this.socket.once('connect', () => {\r\n        this.socket.emit('subscribe', lotId);\r\n      });\r\n    }\r\n  }\r\n\r\n  unsubscribeFromParkingLot(lotId: string): void {\r\n    if (this.socket.connected) {\r\n      this.socket.emit('unsubscribe', lotId);\r\n      console.log(`Unsubscribed from parking lot: ${lotId}`);\r\n    }\r\n  }\r\n\r\n  getOccupancyRate(lot: ParkingLot): number {\r\n    return ((lot.totalSpots - lot.availableSpots) / lot.totalSpots) * 100;\r\n  }\r\n\r\n  getStatusLabel(lot: ParkingLot): string {\r\n    const occupancy = this.getOccupancyRate(lot);\r\n    if (occupancy < 50) return 'Available';\r\n    if (occupancy < 80) return 'Moderate';\r\n    return 'Full';\r\n  }\r\n\r\n  getStatusColor(lot: ParkingLot): string {\r\n    const occupancy = this.getOccupancyRate(lot);\r\n    if (occupancy < 50) return 'green';\r\n    if (occupancy < 80) return 'yellow';\r\n    return 'red';\r\n  }\r\n\r\n  calculateDistance(lat1: number, lng1: number, lat2: number, lng2: number): number {\r\n    const R = 6371;\r\n    const dLat = this.toRad(lat2 - lat1);\r\n    const dLng = this.toRad(lng2 - lng1);\r\n    const a =\r\n      Math.sin(dLat / 2) ** 2 +\r\n      Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) *\r\n      Math.sin(dLng / 2) ** 2;\r\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\r\n    return R * c;\r\n  }\r\n\r\n  private toRad(degrees: number): number {\r\n    return degrees * (Math.PI / 180);\r\n  }\r\n\r\n  disconnect(): void {\r\n    if (this.socket) {\r\n      this.socket.disconnect();\r\n      console.log('WebSocket disconnected manually');\r\n    }\r\n  }\r\n\r\n  reconnect(): void {\r\n    if (this.socket) {\r\n      this.socket.connect();\r\n      console.log('WebSocket reconnecting...');\r\n    }\r\n  }\r\n}\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}